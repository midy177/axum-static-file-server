import{R as A,o as e,x as X,aa as O,n as g,P as V,s as ie,ay as te,q as re,ar as K,N as Q,B as M,I as k,T as I,az as q,Z as S,X as Y,ah as z,aA as ae}from"./vendor-base-cc18fcff.js";import{p as R,m as B,a as E}from"./index-6524c7ed.js";import{z as w,K as ce,M as me,N as de,A as Z,O as pe,q as U,p as J,i as C,P as he,Q as W,S as fe,V as G,W as H,J as D,X as ue,Y as ge}from"./shared-4873712f.js";import"./useColumns-31cfb7a0.js";import{u as be,a as xe,M as je}from"./usePhotoUpload-fd7bbc46.js";import"./style-pages-42a62cad.js";import{u as ee,J as se}from"./index-cbf4ccd1.js";import{c as ve}from"./vendor-c76f9059.js";import"./i18n-helper-ef5bc359.js";import"./__commonjsHelpers__-23102255.js";/* empty css                     */import"./style-shared-6740825f.js";import"./useS3Upload-00eba9e8.js";const ye=A.memo(o=>{const{getIntlText:l}=w(),{accept:m,photoUrl:u,photoPreviewUrl:n,s3UploadRequest:d,handleBeforeUpload:r,handleUploadChange:h}=be(o);return e.jsxs("div",{className:"ms-product-photo",children:[e.jsxs("div",{className:"ms-product-photo-head",children:[e.jsx("span",{className:"ms-title",children:l("mg.product.config.label_photo")}),e.jsx(ce,{children:e.jsx(me,{className:"ms-product-config-photo-upload-select",accept:m,s3UploadRequest:d,beforeUpload:r,onChange:h,children:e.jsx("span",{className:"ms-upload-btn",children:l("common.upload.upload")})})})]}),e.jsx(X,{spinning:!!n,children:e.jsx("div",{className:"ms-product-photo-preview",children:n||u?e.jsx("img",{src:n||u,alt:""},n||u):e.jsx("span",{className:"photo-placeholder",children:l("common.label.placeholder_product_image")})})})]})}),_e=A.memo(({onSave:o,initData:l,...m})=>{const{getIntlText:u}=w(),[n]=O.useForm(),d=async()=>{const r=await n.validateFields();o(r)};return g.useEffect(()=>{m.visible&&n.setFieldsValue(l)},[n,m.visible,l]),e.jsx(V,{title:u("mg.product.detail.modal_title_edit",{1:(l==null?void 0:l.showName)||(l==null?void 0:l.name)}),okText:u("common.button.confirm"),cancelText:u("common.button.cancel"),...m,onOk:d,children:e.jsxs(O,{layout:"vertical",className:"ms-product-detail-edit-form",form:n,children:[e.jsx(O.Item,{name:"photoUrl",children:e.jsx(ye,{})}),e.jsx(O.Item,{name:"remark",label:u("common.label.description"),rules:de(),children:e.jsx(ie,{})})]})})}),Te=A.memo(({onChange:o})=>{const{productId:l=""}=te(),m=re(),{lang:u,getIntlText:n}=w(),{getSysTimeFormat:d}=Z(),[r,h]=g.useState(!1),[x,j]=g.useState(!1),{loading:_,data:s,run:f}=K(async()=>{const p=await R.getProductDetail({productId:l});return U(p)},{refreshDeps:[u],onSuccess(p){o&&o(p)}}),b=g.useMemo(()=>{const p=pe.find(i=>i.value===(s==null?void 0:s.deviceType)),v=p!=null&&p.labelIntlKey?n(p.labelIntlKey):"";return[{label:n("mg.product.info.prop_name_en"),value:(s==null?void 0:s.showName)||(s==null?void 0:s.name)},{label:n("common.label.product_model"),value:s==null?void 0:s.model},{label:n("mg.product.info.prop_identification"),value:s==null?void 0:s.snIdentification},{label:n("mg.product.info.prop_sn_length"),value:s==null?void 0:s.snLength},{label:n("mg.product.info.prop_additional_bits"),value:s==null?void 0:s.snAdditionalBits},{label:n("common.label.type"),value:v},{label:n("mg.product.info.prop_protocol"),value:s==null?void 0:s.communicationProtocol},{label:n("mg.product.info.prop_communication_type"),value:s==null?void 0:s.gatewayType},{label:n("common.label.create_time"),value:s!=null&&s.createTime?d(s.createTime):""},{label:n("common.label.description"),value:s==null?void 0:s.remark}]},[s,n,d]),T=async p=>{j(!0);const[v,i]=await J(R.updateProduct({id:l,...p}));j(!1),!(v||!C(i))&&(f(),h(!1))},y=()=>{he.secondaryConfirm({title:`${n("common.label.delete")} ${n("common.label.product")}`,content:n("common.label.modal_desc_deletion",{1:(s==null?void 0:s.showName)||(s==null?void 0:s.name)}),async onOk(){if(!(s!=null&&s.id))return;const[p,v]=await J(R.deleteProduct({productId:s==null?void 0:s.id}));p||!C(v)||(m("/product"),S.success(n("common.message.delete_success")))}})};return e.jsxs("div",{className:"ms-product-detail-block",children:[e.jsxs("div",{className:"ms-product-detail-block-head",children:[e.jsx("h2",{className:"ms-title",children:n("common.label.basic_info")}),e.jsx("div",{className:"ms-detail-title-extra",children:e.jsxs(Q,{size:"sm",children:[e.jsx(M,{type:"ghost",suffix:e.jsx(k,{type:"icon-edit"}),disabled:!(s!=null&&s.id),onClick:()=>h(!0),children:n("common.button.edit")}),e.jsx(I,{placement:"topRight",title:s!=null&&s.deviceCount?n("mg.product.detail.error_product_device_is_not_empty"):"",children:e.jsx(M,{type:"ghost",suffix:e.jsx(k,{type:"icon-delete"}),disabled:!(s!=null&&s.id)||!!(s!=null&&s.deviceCount),onClick:y,children:n("common.label.delete")})})]})})]}),e.jsx("div",{className:"ms-product-detail-block-body",children:e.jsx(X,{spinning:_,children:e.jsxs("div",{className:"ms-product-detail-wrapper",children:[e.jsx(q,{bordered:!0,size:"small",column:2,children:b.map(p=>e.jsx(q.Item,{label:e.jsx(I,{type:"ellipsisTooltip",title:p.label,children:p.label}),children:e.jsx(I,{type:"ellipsisTooltip",title:p.value,children:p.value})},p.label))}),e.jsx("div",{className:"ms-product-detail-photo",children:s!=null&&s.photoUrl?e.jsx("img",{src:s.photoUrl,alt:""}):e.jsx("span",{className:"photo-placeholder",children:n("common.label.placeholder_product_image")})})]})})}),e.jsx(_e,{visible:r&&!!s,initData:s,confirmLoading:x,onSave:T,onCancel:()=>h(!1)})]})}),we=Te,oe=({type:o,onButtonClick:l,onPaginationRefresh:m,onTableChange:u})=>{const{getIntlText:n}=w(),{getSysTimeFormat:d}=Z(),[r,h]=g.useState({total:0,current:1,pageSize:10}),x=(s,f,b,T)=>{const{current:y,pageSize:p}=s;h({...r,current:y,pageSize:p}),u&&u(s,f,b,T)},j=()=>{const s={...r,current:1,pageSize:10};h(s),m&&m(r)};return{columns:g.useMemo(()=>[{title:n("common.label.version"),dataIndex:"version",key:"version",width:"30%",sorter:(s,f,b)=>{switch(o){case"model":return s.isDefault||f.isDefault?b==="descend"?-1:1:W(s.version,f.version)?1:-1;default:return W(s.version,f.version)?1:-1}}},{title:n("common.label.create_time"),dataIndex:"createTime",key:"createTime",width:"35%",ellipsis:!0,sorter:(s,f,b)=>{switch(o){case"model":return s.isDefault||f.isDefault?b==="descend"?-1:1:s.createTime-f.createTime;default:return s.createTime-f.createTime}},render(s){return d(s)}},{title:n("common.label.operation"),key:"$operation",align:"right",render(s,f){return e.jsxs(Q,{size:"sm",className:"ms-table-pro-oprt align-right",children:[o==="model"&&!f.isDefault&&e.jsx("span",{className:"ms-table-pro-oprt-btn",onClick:()=>l("mark",f),onDoubleClick:b=>b.stopPropagation(),children:e.jsx(I,{title:n("common.label.top"),mouseEnterDelay:.3,children:e.jsx(k,{type:"icon-mark",colorType:"action"})})}),e.jsx("span",{className:"ms-table-pro-oprt-btn",onClick:()=>l("detail",f),onDoubleClick:b=>b.stopPropagation(),children:e.jsx(I,{title:n("common.label.detail"),mouseEnterDelay:.3,children:e.jsx(k,{type:"icon-view-list",colorType:"action"})})}),e.jsx("span",{className:"ms-table-pro-oprt-btn",onClick:()=>l("download",f),onDoubleClick:b=>b.stopPropagation(),children:e.jsx(I,{title:n("common.button.download"),mouseEnterDelay:.3,children:e.jsx(k,{type:"icon-import",colorType:"action"})})})]})}}],[o,n,l,d]),pageInfo:r,setPageInfo:h,handleRefresh:j,handleTableChange:x}},ke=({data:o})=>{const{getIntlText:l}=w(),m=xe();return g.useMemo(()=>[{key:"config",title:l("common.label.view_mode_config"),content:e.jsx(je,{extraWidth:48,columns:m,data:o})},{key:"text",title:l("common.label.view_mode_text"),content:e.jsx(fe,{value:o})}],[o,m,l])},Se=({file:o,data:l,model:m,onSave:u,...n})=>{var p,v,i;const{getIntlText:d}=w(),[r,h]=g.useState({}),x=ke({data:(p=r.data)==null?void 0:p.thingSpecifications}),[j,_]=g.useState(!1),s=async()=>{if(!(y==="view"||!r.data)){_(!0);try{await u(r.data)}catch{}_(!1)}},b=ee({onChange:(t,a)=>{var c;if(!a.productModel||a.productModel!==m){S.error(d("mg.product.detail.error_upload_thing_spec_product_mismatch"));return}if(!((c=a.thingSpecifications)!=null&&c.length)){S.error(d("mg.product.detail.error_upload_tsl_empty_message"));return}h({file:t,data:a})}}),T={...n},y=o?"edit":"view";return y==="view"&&(T.footer=e.jsx(e.Fragment,{})),g.useLayoutEffect(()=>{h({file:o,data:l})},[o,l]),e.jsxs(V,{size:"large",width:1200,title:d("common.label.table_title_tsl"),...T,className:ve("ms-model-manage-modal",{"ms-model-manage-modal-view":y==="view"}),okText:d("common.button.save"),cancelText:d("common.button.cancel"),onOk:s,okButtonProps:{loading:j},children:[y==="edit"&&e.jsx("div",{className:"ms-upload-area",children:e.jsxs(Y.Dragger,{className:"ms-upload-area-inner",...b,children:[e.jsxs("div",{className:"ms-upload-file",children:[e.jsx("span",{className:"ms-icon-wrapper",children:e.jsx(k,{type:"icon-folder"})}),e.jsx(I,{type:"ellipsisTooltip",className:"ms-upload-file-title",title:(v=r.file)==null?void 0:v.name,children:(i=r.file)==null?void 0:i.name})]}),e.jsx(M,{type:"ghost",children:d("common.button.upload_again")})]})}),e.jsx(z,{className:"ms-product-profile-tabs",defaultActiveKey:"config",children:x.map(t=>e.jsx(z.TabPane,{tab:t.title,children:t.content},t.key))})]})},Pe=({productData:o})=>{const{getIntlText:l}=w(),{getDownloadFilename:m}=G(),[u,n]=g.useState({}),[d,r]=g.useState(!1),{loading:h,data:x,run:j}=K(async()=>{if(!(o!=null&&o.id))return;const i=await B.getThingSpecs({productId:o.id});return U(i)},{refreshDeps:[o==null?void 0:o.id],onSuccess(i){var t;b({...f,total:((t=i==null?void 0:i.list)==null?void 0:t.length)||0})}}),_=g.useCallback(async(i,t)=>{if(o!=null&&o.id)switch(i){case"detail":{const a=await B.getThingSpecDetail({productId:o.id,version:t.version}),c=U(a);if(!C(a)||!c)return;n({data:{thingSpecifications:[c]}}),r(!0);break}case"mark":{const a=await B.setDefaultThingSpec({productId:o.id,version:t.version});if(!C(a))return;j();break}case"download":{const a=await B.getThingSpecDetail({productId:o.id,version:t.version});if(!C(a))return;const c={thingSpecifications:[U(a)]},N=new Blob([JSON.stringify(c,void 0,4)],{type:"text/json"});H(URL.createObjectURL(N),m("product-tsl","json"));break}}},[o,m,j]),{columns:s,pageInfo:f,setPageInfo:b,handleRefresh:T,handleTableChange:y}=oe({type:"model",onButtonClick:_,onPaginationRefresh:()=>j()}),p=async i=>{var a;if(!(o!=null&&o.id)||!((a=i.thingSpecifications)!=null&&a.length))return;const t=await R.addTSLorProfile({productId:o.id,i18n:i.i18n,parser:i.parser,thingSpecifications:i.thingSpecifications});C(t)&&(j(),n({}),r(!1))},v=(i,t)=>{var a,c;if(!t.productModel||t.productModel.toLocaleLowerCase()!==((a=o==null?void 0:o.model)==null?void 0:a.toLocaleLowerCase())){S.error(l("mg.product.detail.error_upload_thing_spec_product_mismatch"));return}if(!((c=t.thingSpecifications)!=null&&c.length)){S.error(l("mg.product.detail.error_upload_tsl_empty_message"));return}r(!0),n({file:i,data:t})};return e.jsxs(e.Fragment,{children:[e.jsx(D,{name:"table-model-manage",rowKey:"createTime",loading:h,rowClassName:i=>i.isDefault?"active":"",toolbarRender:e.jsx(se,{onChange:v,children:e.jsx(M,{type:"ghost",disabled:!(o!=null&&o.id),suffix:e.jsx(k,{type:"icon-upload"}),children:l("common.upload.upload")})}),pagination:f,columns:s,dataSource:x==null?void 0:x.list,onChange:y,onRefresh:T,onRow:i=>({onDoubleClick:()=>_("detail",i)})}),e.jsx(Se,{...u,model:o==null?void 0:o.model,visible:d,onSave:p,onCancel:()=>{n({}),r(!1)}})]})},Ce=({file:o,data:l,model:m,onSave:u,...n})=>{var v,i;const{getIntlText:d}=w(),[r,h]=g.useState({}),[x,j]=g.useState(null),[_,s]=g.useState(!1),f={...n},b=o?"edit":"view";b==="view"&&(f.footer=e.jsx(e.Fragment,{}));const T=async()=>{if(!(b==="view"||!r.data)){s(!0);try{await u(r.data)}catch{}s(!1)}},p=ee({onChange:(t,a)=>{var c;if(!a.productModel||a.productModel!==m){S.error(d("mg.product.detail.error_upload_profile_product_mismatch"));return}if(!((c=a.configurationProfiles)!=null&&c.length)){S.error(d("mg.product.detail.error_upload_profile_empty_message"));return}h({file:t,data:a})}});return g.useLayoutEffect(()=>{h({file:o,data:l})},[o,l]),g.useLayoutEffect(()=>{var a,c;const t=(c=(a=r.data)==null?void 0:a.configurationProfiles)!=null&&c.length?r.data.configurationProfiles[0]:void 0;t&&j(t)},[r.data]),e.jsxs(V,{size:"large",width:1200,title:d("common.label.table_title_profile"),...f,className:"ms-profile-manage-modal",okText:d("common.button.save"),cancelText:d("common.button.cancel"),onOk:T,okButtonProps:{loading:_},children:[b==="edit"&&e.jsx("div",{className:"ms-upload-area",children:e.jsxs(Y.Dragger,{className:"ms-upload-area-inner",...p,children:[e.jsxs("div",{className:"ms-upload-file",children:[e.jsx("span",{className:"ms-icon-wrapper",children:e.jsx(k,{type:"icon-folder"})}),e.jsx(I,{type:"ellipsisTooltip",className:"ms-upload-file-title",title:(v=r.file)==null?void 0:v.name,children:(i=r.file)==null?void 0:i.name})]}),e.jsx(M,{type:"ghost",children:d("common.button.upload_again")})]})}),e.jsx(ue,{readOnly:!0,height:567,profileJson:x,schemaFormData:x==null?void 0:x.form,emptyProps:{size:"small"}})]})},Ie=({productData:o})=>{const{getIntlText:l}=w(),{getDownloadFilename:m}=G(),[u,n]=g.useState({}),[d,r]=g.useState(!1),h=g.useCallback(async(i,t)=>{const[a,c]=await J(Promise.all([E.getProfileDetail({profileId:t.id}),E.getProfileForm({profileId:t.id})])),N=c==null?void 0:c.every(P=>C(P));if(!(c!=null&&c.length)||!N||a)return;const L={version:"",type:"profile"};for(let P=0;P<c.length;P++){const ne=c[P],F=U(ne);switch(P){case 0:{Object.assign(L,F);break}case 1:{const le=F&&typeof F=="string"?F:"{}";L.form=JSON.parse(le);break}}}const $={configurationProfiles:[L]};switch(i){case"detail":{n({data:$}),r(!0);break}case"download":{const P=new Blob([JSON.stringify($,void 0,4)],{type:"text/json"});H(URL.createObjectURL(P),m("product-profile","json"));break}}},[m]),{columns:x,pageInfo:j,setPageInfo:_,handleRefresh:s,handleTableChange:f}=oe({type:"profile",onButtonClick:h,onPaginationRefresh:()=>y&&y()}),{loading:b,data:T,run:y}=K(async()=>{if(!(o!=null&&o.id))return;const i=await E.getProfiles({productId:o==null?void 0:o.id});return U(i)},{refreshDeps:[o==null?void 0:o.id],onSuccess(i){_({...j,total:(i==null?void 0:i.length)||0})}}),p=async i=>{var c;if(!(o!=null&&o.id)||!((c=i.configurationProfiles)!=null&&c.length))return;const t=i.configurationProfiles.map(N=>{const L=N.form&&JSON.stringify(N.form);return{...N,form:L}}),a=await R.addTSLorProfile({productId:o.id,i18n:i.i18n,configurationProfiles:t});C(a)&&(y(),n({}),r(!1))},v=(i,t)=>{var a,c;if(!t.productModel||t.productModel.toLocaleLowerCase()!==((a=o==null?void 0:o.model)==null?void 0:a.toLocaleLowerCase())){S.error(l("mg.product.detail.error_upload_profile_product_mismatch"));return}if(!((c=t.configurationProfiles)!=null&&c.length)){S.error(l("mg.product.detail.error_upload_profile_empty_message"));return}r(!0),n({file:i,data:t})};return e.jsxs(e.Fragment,{children:[e.jsx(D,{name:"table-profile-manage",rowKey:"id",loading:b,toolbarRender:e.jsx(se,{onChange:v,children:e.jsx(M,{type:"ghost",disabled:!(o!=null&&o.id),suffix:e.jsx(k,{type:"icon-upload"}),children:l("common.upload.upload")})}),pagination:j,columns:x,dataSource:T,onChange:f,onRefresh:s,onRow:i=>({onDoubleClick:()=>h("detail",i)})}),e.jsx(Ce,{...u,model:o==null?void 0:o.model,visible:d,onSave:p,onCancel:()=>{n({}),r(!1)}})]})},Ne=({productData:o})=>{const{getIntlText:l}=w();return g.useMemo(()=>[{key:"model",title:l("mg.product.config.tab_title_object_model_management"),content:e.jsx(Pe,{productData:o})},{key:"profile",title:l("mg.product.config.tab_title_profile_management"),content:e.jsx(Ie,{productData:o})}],[l,o])},$e=()=>{const{pathname:o,state:l}=ae(),[m,u]=g.useState(l),n=Ne({productData:m}),[d,r]=g.useState("model");return e.jsxs(e.Fragment,{children:[e.jsx(ge,{titles:{[o]:(m==null?void 0:m.name)||""}}),e.jsxs("div",{className:"ms-main ms-main-transparent ms-main-product-detail",children:[e.jsx(we,{onChange:u}),e.jsx("div",{className:"ms-product-detail-block",children:e.jsx(z,{className:"ms-product-profile-tabs",defaultActiveKey:d,onChange:h=>r(h),children:n.map(h=>e.jsx(z.TabPane,{tab:h.title,children:h.content},h.key))})})]})]})};export{$e as default};
